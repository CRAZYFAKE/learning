[TOC]

# 问题

## Eloquent ORM

### API 资源 Resource的使用

**使用方法参考：**[Eloquent: API 资源](https://d.laravel-china.org/docs/5.5/eloquent-resources#Eloquent-API-资源)

**类：** `Illuminate\Http\Resources\Json\Resource`

**问题：**比如我有个用户模型，想给这个模型添加「额外的数据」， 

`Resource`类中有一个叫做「添加元数据」`public function additional(array $data)` 的方法，可以供我们使用。

**栗子：**

创建 `UserResource` 

```shell
php artisan make:resource User
```

在 `UserResource.php` 写下面的代码：

```php
<?php

namespace App\Http\Resources;

use Illuminate\Http\Resources\Json\Resource;

class User extends Resource
{
    public function toArray($request)
    {
        $resource = [
            '_id'                   => $this->id,
            'email'                 => $this->email,
            'phone'                 => $this->phone,
            'loggedinAtMs'          => $this->loggedinAtMs
        ];
        return $resource;
    }
}
```

在 `UserController.php` 里面有一个方法：

```php
public function getUserInfo()
{
   $user = User::first();
   $token = 'token';
   $result = new UserResource($user);
   $result->additional([
       'data'   => ['token' => $token],
       'status' => 1,
       'msg'    => '成功'
   ]);
   return $result;
}
```

通过接口获取数据：

```json
{
  "status": 1,
  "msg": "成功",
  "data": {
    "id": 104,
    "email": "",
    "phone": "1",
    "token": "token"
  }
}
```

可以看到 `token` 是可以加进去的。

我们看一下代码：

接口返回数据，是直接把 `UserResource`的实例 `$result` 返回给了客户端

因为 `Illuminate\Http\Resources\Json\Resource` 类实现了 `Illuminate\Contracts\Support\Responsable` 接口的  `toResponse` 方法，看一下 `toResponse` 的具体实现，

```php
/**
* Create an HTTP response that represents the object.
*
* @param  \Illuminate\Http\Request  $request
* @return \Illuminate\Http\JsonResponse
*/
public function toResponse($request)
{
	return (new ResourceResponse($this))->toResponse($request);
}
```

再看一下 `ResourceResponse` 类的 `toResponse` 方法，

```php
/**
* Create an HTTP response that represents the object.
*
* @param  \Illuminate\Http\Request  $request
* @return \Illuminate\Http\JsonResponse
*/
public function toResponse($request)
{
	return tap(response()->json(
		$this->wrap(
			$this->resource->resolve($request),
			$this->resource->with($request),
			$this->resource->additional
		),
		$this->calculateStatus()
	), function ($response) use ($request) {
		$this->resource->withResponse($request, $response);
	});
}
```

这里会把 `$with` 和 `$additional` 以及 `toArray()` 方法的所有数据【合并】，所以就会把前面调用 `additional` 方法添加的数据，全部添加到最终返回结果中。

 **但是**，如果不直接返回 `$result` ，而是再给包一层数据：

```php
public function getUserInfo()
{
   $user = User::first();
   $token = 'token';
   $result = new UserResource($user);
   $result->additional([
       'data'   => ['token' => $token],
       'status' => 1,
       'msg'    => '成功'
   ]);
  $finalResult = [
  	   'finalResult' => $result
  ]
   return $finalResult;
}
```

这样的话，并不会走 `Illuminate\Http\Resources\Json\Resource` 的 `toResponse` 方法，所以最终也不会把`additional()` 函数添加的 额外数据，返回给客户端。

可以使用 `Model` 的 `toArray()` 方法返回数据，直接返回 `Model` 实例，也就是复写 `Illuminate\Database\Eloquent\Model` 的 `toArray()` 方法。



## Artisan

### [MySQL] 1071 Specified key was too long; max key length is 767 bytes

**Laravel5.5 执行 php artisan migrate 时报错**

**报错：**

```shell
[Illuminate\Database\QueryException]                                                                                                
SQLSTATE[42000]: Syntax error or access violation: 1071 Specified key was too long; max key length is 767 bytes (SQL: alter table `users` add unique `users_email_unique`(`email`))      
  
[PDOException]                                                                                                   
SQLSTATE[42000]: Syntax error or access violation: 1071 Specified key was too long; max key length is 767 bytes
```

**问题原因：**

官方文档：https://github.com/laravel/docs/blob/5.5/migrations.md#index-lengths--mysql--mariadb

> 原文：
>
> Laravel uses the `utf8mb4` character set by default, which includes support for storing "emojis" in the database. If you are running a version of MySQL older than the 5.7.7 release or MariaDB older than the 10.2.2 release, you may need to manually configure the default string length generated by migrations in order for MySQL to create indexes for them. You may configure this by calling the `Schema::defaultStringLength` method within your `AppServiceProvider`。

意思是：

> Laravel 默认使用 `utf8mb4` 字符，支持在数据库存储「表情」。如果你的 MySQL release 版本低于 5.7.7 或 MariaDB release 版本低于 10.2.2，为了成功创建索引，就需要手动去配置迁移时的默认长度。通过在调用 `AppServiceProvider` 中的 `Schema::defaultStringLength` 方法来配置它。

**解决方法：**

https://github.com/laravel/framework/issues/17508

修改 `AppServiceProvider.php` 的 `boot()`函数，添加 `Schema::defaultStringLength(191);`

如下：

```php
public function boot()
{
  Schema::defaultStringLength(191);
}
```

### [MySQL]  SQLSTATE[HY000 [2002] No such file or directory

**问题原因：** [MySQL 官方解释](https://dev.mysql.com/doc/refman/5.6/en/can-not-connect-to-server.html)

意思是：在 Unix 上的 MySQL 客户端，连接 [**mysqld**](https://dev.mysql.com/doc/refman/5.6/en/mysqld.html) 服务有两种方式：

1. 通过 Unix socket 文件连接，默认文件是 `/tmp/mysql.sock` ，MAMP 的 socket 文件是 `/Applications/MAMP/tmp/mysql/mysql.sock`
2. 通过 TCP/IP 连接，而且需要一个端口号

Unix socket 连接速度比 TCP/IP 连接速度快，但是它只能连接同一台电脑的 MySQL 服务。

**回到我们的问题：**

如果使用 MAMP 开发的话，服务器启动后，

打开 http://localhost:8888/MAMP/?language=English

里面有关于 MySQL 怎么连接：

MySQL can be administered with [phpMyAdmin](http://localhost:8888/MAMP/index.php?page=phpmyadmin&language=English).												

To connect to the MySQL server from your own scripts use the following connection parameters:

| Host     | localhost                               |
| -------- | --------------------------------------- |
| Port     | 8889                                    |
| User     | root                                    |
| Password | root                                    |
| Socket   | /Applications/MAMP/tmp/mysql/mysql.sock |

坑不坑，这里默认就是 socket 连接了。所以别折腾 TCP/IP 连接了。

**具体配置：**

1）先打开 `config/database.php` 文件，找到 `connections` 数组，再找 `mysql` 字段，

确保 `mysql` 里面有下面的代码：

```.env
'unix_socket' => env('DB_SOCKET', ''),
```

如果没有的话，那直接加进去就好

2）在 `.env` 文件添加一行代码：

```.env
DB_SOCKET=/Applications/MAMP/tmp/mysql/mysql.sock
```

