[TOC]



## 闭包



### 一. 变量的作用域

变量作用域分为两种 : `全局变量` 和 `局部变量`

1. JavaScript 函数内部可以直接读取 `全局变量` 
2. 函数外部无法读取函数内部的 `局部变量`

> 函数内部声明变量时, 一定要使用 `var` 命令, 如果不用的话, 实际上声明了一个全局变量

```javascript
all = 'outer';

function func() {
  all = 'inner';
}

console.log(all); // outer
func();
console.log(all); // inner
```



### 二. 如何从外部读取局部变量?

在函数内部, 再定义一个函数

```JavaScript
function f1() {
    var n = 999;
    function f2() {
        console.log(n);
    }
}
```

上面代码中, 函数f2被包括在函数f1内部, 这是函数f1内所有的局部变量, 对f2都是可见的。但是反过来就不行，f2内的局部变量，对f1是不可见的。

这就是 JavaScript 语言特有的 `链式作用域` 结构，子对象会一级一级地向上寻找所有父对象的变量。所以父对象的所有变量，对子对象来说都是可见的，反之则不成立。

既然f2可以读取f1中的局部变量，那么只要把f2作为返回值，那么我们就可以在f1外部读取它的内部变量了。

```JavaScript
function f1() {
    var n = 999;
    function f2() {
        return n;
    }
    return f2;
}
var result = f1();
result(); // 999
```



### 三. 闭包的概念

> 闭包就是 **能够读取其他函数内部变量的函数**

由于在Javascript语言中，只有函数内部的子函数才能读取局部变量，因此可以把闭包简单理解成"定义在一个函数内部的函数"。

本质上，**闭包就是将函数内部和函数外部连接起来的一座桥梁。**



### 四. 闭包的用途

它的最大两个用处有两个

1. 上面提到的可以读取函数内部变量的值
2. 让这些变量的值始终保存在内存中，下面是一个例子

```JavaScript
function f1() {
    var n = 999;
    nAdd = function() { n+=1 }
    function f2() {
        console.log(n);
    }
    return f2;

}

var result = f1();
result(); // 999
nAdd();
result(); // 1000
```

上述代码中，`result` 实际上是闭包f2函数。它一共运行了两次，第一次的值是999，第二次的值是1000。这证明了函数 f1中的局部变量n一直保存在内存中，并没有在f1调用后被自动清除。

原因：f1 是 f2的父函数，而 f2 被赋值给了一个全局变量 result。这导致f2始终在内存中，而f2的存在依赖于f1，因此f1也始终在内存中，不会再调用结束后，被垃圾回收机制回收。



### 五.使用闭包的注意点

1. 闭包使得函数中的变量都保存在内存中，内存消耗大，所以不能滥用。

   解决方法是，在退出函数之前，将不使用的局部变量全部删除。

2. 闭包会在父函数外部，改变福函数内部变量的值。所以，如果把父函数当做对象使用，把闭包当作它的公用方法（Public Method），把内部变量当作它的私有属性（private value），这时一定要小心，不要随便改变父函数内部变量的值。



